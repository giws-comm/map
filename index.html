<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Global Water Futures</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <style>
    #map {
      position: absolute;
      /* left: 25%; */
      top: 0;
      bottom: 0;
      /* width: 75%; */
    }

    .mapboxgl-popup-content{
      background: rgba(255, 255, 255, 0.8);
    }

    /* #navbarContainer {
      display: inline-block;
      cursor: pointer;
      position: absolute;
      width: 130px;
      height: 150px;
      top: 30px;
      background-color: red;
      display: block;
    }

    #navbarContainer .navbar {
      width: 50%;
      height: 15px;
      background-color: black;
    } */

    #observatoryViewButton {
      position: absolute;
      top: 2%;
      left: 1%;
      width: 12.45%;
      height: 3%;
      border-radius: 10px 10px 0px 0px;
      /* background: rgba(145, 145, 145, 0.7); */
      background: rgba(	221, 221, 221, 0.7);
      border-bottom: thin solid black;
      padding-top: 0.5%;
      text-align: center;
      cursor: pointer;
      font: 15px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      font-weight: bold;
      display: none;
    }

    #projectViewButton {
      position: absolute;
      top: 2%;
      left: 13.55%;
      width: 12.45%;
      height: 3%;
      border-radius: 10px 10px 0px 0px;
      background: rgba(145, 145, 145, 0.7);
      /* background: rgba(	61, 61, 61, 0.7); */
      padding-top: 0.5%;
      text-align: center;
      cursor: pointer;
      font: 15px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      display: none;
    }

    #listViewButton {
      position: absolute;
      /* top: 75px; */
      top: 11.5%;
      /* left: 485px; */
      left: 26%;
      width: 2%;
      height: 3%;
      border-radius: 0px 5px 5px 0px;
      background: rgba(145, 145, 145, 0.7);
      /* background: rgba(	61, 61, 61, 0.7); */
      cursor: pointer;
      display: none;
    }

    .listViewButtonLines {
      /* width: 25px;
      height: 2px;
      margin-top: 3px;
      margin-left: 8px; */
      width: 80%;
      height: 7%;
      margin-top: 10%;
      margin-left: 10%;
      background-color: white;
    }

    .listViewButtonLines:first-child {
      margin-top: 12%;
    }

    #thumbnailViewButton {
      position: absolute;
      /* top: 115px; */
      top: 15%;
      /* left: 485px; */
      left: 26%;
      width: 2%;
      height: 3%;
      border-radius: 0px 5px 5px 0px;
      /* background: rgba(	61, 61, 61, 0.7); */
      /* background: rgba(196, 196, 196, 0.7); */
      background: rgba(145, 145, 145, 0.7);
      cursor: pointer;
      display: none;
    }

    .thumbnailViewButtonBoxes {
      float: left;
      width: 30%;
      height: 30%;
      margin-top: 10%;
      margin-left: 15%;
      background-color: white;
      /* background-color: rgba(	255, 255, 255, 0.7);; */
    }

    #closebtnContainer {
      position: absolute;
      width: 25%;
      height: 30px;
      top: 20px;
      left: 20px;
      /* background-color: #fff; */
      background: rgba(145, 145, 145, 0.5);
      display: none;
      padding-top: 3px;
      font-size: 20px;
      text-align: center;
      /* border-radius: 10px; */
      /* display: none; */
    }

    #closebtnContainer .closebtn {
      /* position: absolute; */
      /* height: 30px; */
      top: 0;
      float: right;
      /* right: 25px; */
      font-size: 20px;
      /* margin-left: 50px; */
      color: black;
    }

    .map-overlay {
      position: absolute;
      width: 25%;
      /* top: 20px; */
      top: 6.1%;
      /* bottom: 30px; */
      bottom: 3%;
      /* left: 10px; */
      left: 1%;
      font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      /* background-color: #dddddd; */
      background: rgba(221, 221, 221, 0.5);
      max-height: 100%;
      overflow: hidden;
      border-radius: 0px 0px 10px 10px;
      display: none;
    }

    .map-overlay fieldset {
      display: none;
      /* background: #c4c4c4; */
      background-color: rgba(196, 196, 196, .5);
      border: none;
      padding: 10px;
      margin: 0;
    }

    .map-overlay input {
      display: block;
      border: none;
      width: 100%;
      border-radius: 3px;
      padding: 10px;
      margin: 0;
      background-color: rgba(255, 255, 255, .5);
      box-sizing: border-box;
    }

    .map-overlay .listing {
      overflow: auto;
      max-height: 100%;
    }

    .map-overlay .listing .divListContainer {
      float: left;
      width: 95%;
      padding: 5px 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      overflow: hidden;
      /* text-overflow: ellipsis; */
    }

    /* .map-overlay .listing .divListContainer>* {
      display: block;
      padding: 5px 10px;
      margin: 0;
    } */

    .map-overlay .listing .divListContainer span {
      /* display: inline-block; */
      /* position: absolute; */
      /* float: right; */
      /* width:10px; */
      width: 2%;
      /* height: 2%; */
      margin-right: 2%;
      padding-right: 2%;

    }

    .map-overlay .listing .divListContainer a {
      /* position: absolute; */
      /* border-bottom: 1px solid rgba(0, 0, 0, 0.1); */
      /* color: #404; */
      /* padding-left: 5%; */
      width: 70%;
      /* white-space: nowrap; */
      /* overflow: hidden; */
      /* text-overflow: ellipsis; */
    }

    /* .divListContainer:last-child {
      border-bottom:: 2px solid rgba(255, 255, 255, 1);
    } */

    /* .divListContainer a {

    } */

    .map-overlay .listing .divListContainer .dummyDiv {
      width: 100%;
      height: 50px;
    }

    .map-overlay .divContainer {
      /* position: relative */
      /* margin: 4px; */
      float: left;
      width: 45%;
      height: 150px;
      /* padding: 5px; */
      /* margin: 5px; */
      padding: 1%;
      margin: 1%;
      /* border: 1px solid #ff3366; */
      /* white-space: nowrap; */
      /* overflow: hidden; */
      /* text-overflow: ellipsis; */
      background-color: #fff;
      /* border-bottom: 1px solid rgba(0, 0, 0, 0.3); */
    }

    .divImgContainer {
      margin: 2%;
      /* float: left; */
      /* width: 43%; */
      height: 120px;
      text-align: center;
      object-fit: cover;
      /* display:block; */
      /* border: 1px solid blue; */
      /* background-color: #444; */
    }

    .divImgContainer img {
      width: 100%;
      height: 120px;
      /* max-width: 100%;
      max-height: 100%; */
      /* display:block; */
      /* height: auto; */
      /* width: auto; */
    }

    .divContainer:hover .divTextContainer {
      opacity: .6;
    }

    .divContainer:hover {
      box-shadow: 5px 5px 5px grey;
      cursor: pointer;
    }

    .divContainer:hover img {
      opacity: 0.5;
    }

    .divNameContainer {
      margin: 2%;
      padding-left: 2px;
      /* float: left; */
      /* width: 43%; */
      /* height: 5%; */
      /* border: 1px solid green; */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background-color: #fff;
    }

    .divTextContainer {
      transition: .5s ease;
      opacity: 0;
      /* position: absolute; */
      /* top: 0; */
      /* left: 0; */
      top: 50%;
      left: 50%;
      transform: translate(0, -95px);
      /* -ms-transform: translate(-50%, -50%); */
      text-align: center;
    }

    .divText {
      color: white;
      font-size: 15px;
    }

    .map-overlay .divItemDetailsContainer {
      margin: 2%;
      /* margin-top: 10px; */
      /* width: 100%; */
      /* height: 100px; */
      background-color: rgba(221, 221, 221, .9);
      padding-bottom: 2px;
    }

    .divImgDetailsContainer {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .divImgDetailsContainer img {
      width: 100%;
      height: 200px;
    }

    .divNameDetailsContainer {
      margin: 2%;
      padding-left: 2px;
      /* float: left; */
      /* width: 43%; */
      /* height: 5%; */
      /* border: 1px solid green; */
      /* white-space: nowrap; */
      overflow: hidden;
      /* text-overflow: ellipsis; */
      background-color: #dddddd;
    }

    .divTextDetailsContainer {
      margin: 2%;
      padding-left: 2px;
      /* margin-bottom: 10px; */
      /* float: left; */
      /* width: 43%; */
      /* height: 5%; */
      /* border: 1px solid green; */
      /* white-space: nowrap; */
      overflow: hidden;
      /* text-overflow: ellipsis; */
      background-color: #dddddd;
    }

    .divProjectDetailsContainer {
      margin: 2%;
      padding-left: 2px;
      /* margin-bottom: 10px; */
      /* float: left; */
      /* width: 43%; */
      /* height: 5%; */
      /* border: 1px solid green; */
      /* white-space: nowrap; */
      overflow: hidden;
      /* text-overflow: ellipsis; */
      background-color: #dddddd;
    }

    .divCoIDetailsContainer{
      margin: 2%;
      padding-left: 2px;
      /* margin-bottom: 10px; */
      /* float: left; */
      /* width: 43%; */
      /* height: 5%; */
      /* border: 1px solid green; */
      /* white-space: nowrap; */
      overflow: hidden;
      /* text-overflow: ellipsis; */
      background-color: #dddddd;
    }

    .divLinkDetailsContainer{
      margin: 2%;
      padding-left: 2px;
      /* margin-bottom: 10px; */
      /* float: left; */
      /* width: 43%; */
      /* height: 5%; */
      /* border: 1px solid green; */
      /* white-space: nowrap; */
      overflow: hidden;
      /* text-overflow: ellipsis; */
      background-color: #dddddd;
    }

    /* .divFocusDetails{
      overflow: hidden;
    } */

    #menuMapToggle {
      background: #fff;
      /* position: absolute; */
      opacity: .8;
      /* z-index: 1; */
      top: 20px;
      /* right: 400px; */
      /* display: block; */
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      margin: 0px auto 0px;
      width: 25%;
      /* width: 120px; */
      /* border: 1px solid rgba(0, 0, 0, 0.4); */
      font-family: 'Open Sans', sans-serif;
      /* font-family: "Trebuchet MS", Helvetica, sans-serif; */
      /* display: flex; */
      /* justify-content: center; */
    }

    #menuLayerToggle {
      /* background: #fff; */
      position: absolute;
      opacity: .8;
      z-index: 1;
      top: 20px;
      right: 10px;
      border-radius: 10px;
      width: 120px;
      /* border: 1px solid rgba(0, 0, 0, 0.4); */
      /* font-family: 'Open Sans', sans-serif; */
      font-family: "Trebuchet MS", Helvetica, sans-serif;
    }

    #menuLayerToggle a {
      font-size: 15px;
      color: black;
      display: block;
      margin: 0;
      padding: 0;
      padding: 10px;
      text-decoration: none;
      border-bottom: 1px solid rgba(0, 0, 0, 0.25);
      text-align: center;
      border-radius: 10px;
      background: #fff;
    }

    #menuLayerToggle a:last-child {
      border: none;
    }

    #menuLayerToggle a:hover {
      background-color: #f8f8f8;
      color: black;
      font-weight: bold;
    }

    #menuLayerToggle a.active {
      /* background-color: #3887be; */
      /* background-color: #005129; */
      background-color: #dddddd;
      color: black;
      font-weight: bold;
      font-size: 15px;
    }

    #menuLayerToggle a.active:hover {
      /* background: #3074a4; */
      /* background: #006b36; */
      background: #b7b7b7;
      font-weight: normal;
    }

    .colorPickerClass {
      background-color: rgba(221, 221, 221, .7);
      bottom: 250px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      padding: 5px;
      position: absolute;
      right: 11px;
      z-index: 1;
      float: left;
      border-radius: 10px;
      display: inline-block;
      text-align: center;
      /* font-weight: bold; */
    }

    .colorPickerClass h4 {
      margin: 0;
    }

    .legend {
      /* background-color: #dddddd; */
      background-color: rgba(221, 221, 221, .7);
      bottom: 30px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
      padding: 10px;
      position: absolute;
      right: 10px;
      z-index: 1;
      border-radius: 10px;
    }

    .legend h4 {
      text-align: center;
      margin: 0 0 10px;
    }

    .legend div span {
      display: inline-block;
      height: 10px;
      margin-right: 5px;
      width: 10px;
    }
  </style>

  <nav id="menuLayerToggle"></nav>

  <div id="map"></div>

  <div id="menuMapToggle"> <b>Base Map</b> <br>
    <input id="streets-v11" type="radio" name="rtoggle" value="streets" onClick="switchBaseMap(1)" />
    <label for="streets-v11">Streets</label>
    <input id="light-v10" type="radio" name="rtoggle" value="light" onClick="switchBaseMap(2)" />
    <label for="light-v10">Light</label>
    <input id="dark-v10" type="radio" name="rtoggle" value="dark" onClick="switchBaseMap(3)" />
    <label for="dark-v10">Dark</label>
    <input id="outdoors-v11" type="radio" name="rtoggle" value="outdoors" onClick="switchBaseMap(4)" />
    <label for="outdoors-v11">Outdoors</label>
    <input id="satellite-custom" type="radio" name="rtoggle" value="satellite-custom" onClick="switchBaseMap(5)" />
    <label for="satellite-custom">Satellite</label>
    <input id="custom" type="radio" name="rtoggle" value="custom" checked="checked" onClick="switchBaseMap(6)" />
    <label for="custom">Custom</label>
  </div>

  <div id="listViewButton" onclick="showListView()">
    <div class="listViewButtonLines" id="listViewButtonLines1"></div>
    <div class="listViewButtonLines" id="listViewButtonLines2"></div>
    <div class="listViewButtonLines" id="listViewButtonLines3"></div>
    <div class="listViewButtonLines" id="listViewButtonLines4"></div>
  </div>
  <div id="thumbnailViewButton" onclick="showThumbnailView()">
    <div class="thumbnailViewButtonBoxes" id="thumbnailViewButtonBoxes1"></div>
    <div class="thumbnailViewButtonBoxes" id="thumbnailViewButtonBoxes2"></div>
    <div class="thumbnailViewButtonBoxes" id="thumbnailViewButtonBoxes3"></div>
    <div class="thumbnailViewButtonBoxes" id="thumbnailViewButtonBoxes4"></div>
  </div>

  <div id="observatoryViewButton" onclick="showObservatoryView()">Observatories</div>
  <div id="projectViewButton" onclick="showProjectView()">Projects</div>

  <div id="closebtnContainer"> Observatory List <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">X </a></div>
  <div class="map-overlay" id="sidebar">
    <fieldset>
      <input id="feature-filter" type="text" placeholder="Filter results by observatory name" />
    </fieldset>
    <div id="feature-listing" class="listing">
      <!-- <div class = "dummyDiv"></div> -->
    </div>

  </div>

  <div id="colorPicker" class="colorPickerClass">
    <h4>Basin Color Palette</h4>
    <input type="radio" name="edit" value="A" onclick="colorPaletteChange(1)">1
    <input type="radio" name="edit" value="B" onclick="colorPaletteChange(2)">2
    <input type="radio" name="edit" value="A" onclick="colorPaletteChange(3)">3
    <input type="radio" name="edit" value="B" onclick="colorPaletteChange(4)">4
    <input type="radio" name="edit" value="C" onclick="colorPaletteChange(5)">5
    <input type="radio" name="edit" value="A" onclick="colorPaletteChange(6)">6
    <input type="radio" name="edit" value="C" checked="checked" onclick="colorPaletteChange(7)">7
  </div>

  <div id="basin-legend" class="legend">
    <h4>Major River Basins</h4>
    <div><span id="legendspan1"></span>Yukon River Basin</div>
    <div><span id="legendspan2"></span>Mackenzie River Basin</div>
    <div><span id="legendspan3"></span>Churchill River Basin</div>
    <div><span id="legendspan4"></span>Fraser River Basin</div>
    <div><span id="legendspan5"></span>Columbia River basin</div>
    <div><span id="legendspan6"></span>Nelson - Saskatchewan River Basin</div>
    <div><span id="legendspan7"></span>St. Lawrence River Basin</div>
    <div><span id="legendspan8"></span>Saint. John River Basin</div>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiaGFzbmF0MTI5NyIsImEiOiJja2gyZmozN3EwMm0xMnlxcnJlNjE2ZXIyIn0.JGVcpK9BELAP1RAtMrELtA';
    var map = new mapboxgl.Map({
      container: 'map',
      // style: 'mapbox://styles/mapbox/satellite-v9',
      // style: 'mapbox://styles/mapbox/satellite-streets-v11',

      // style: 'mapbox://styles/mapbox/streets-v11',
      // style: 'mapbox://styles/mapbox/outdoors-v11',
      // style: 'mapbox://styles/mapbox/light-v10',
      // style: 'mapbox://styles/mapbox/dark-v10',
      // style: 'mapbox://styles/hasnat1297/ckh8lxbs30ltw19muxkx3awoo',
      style: 'mapbox://styles/hasnat1297/ckh4bxpbr02j619lbwyc5r1jv',
      // center: [-114.4500116, 62.58332647],
      center: [-118.018093, 58.321212],
      zoom: 3.2,
      maxZoom: 15,
      minZoom: 2.5
    });

    function switchBaseMap(m) {
      if (m == 1) {
        map.setStyle('mapbox://styles/mapbox/streets-v11');
      } else if (m == 2) {
        map.setStyle('mapbox://styles/mapbox/light-v10');
      } else if (m == 3) {
        map.setStyle('mapbox://styles/mapbox/dark-v10');
      } else if (m == 4) {
        map.setStyle('mapbox://styles/mapbox/outdoors-v11');
      } else if (m == 5) {
        map.setStyle('mapbox://styles/hasnat1297/ckh8lxbs30ltw19muxkx3awoo');
      } else if (m == 6) {
        map.setStyle('mapbox://styles/hasnat1297/ckh4bxpbr02j619lbwyc5r1jv');
      }
      // map.removeLayer("Basins");
      // map.removeLayer("Observatory");
      // map.addLayer({
      //   'id': 'Basins',
      //   'type': 'fill',
      //   'source': 'basinSouce',
      //   'layout': {
      //     'visibility': 'visible'
      //   },
      //   'paint': {
      //     'fill-color': ['match',
      //       ['get', 'NAMRB_EN'],
      //       'Yukon',
      //       colorPalette[0],
      //       'Mackenzie',
      //       colorPalette[1],
      //       'Churchill',
      //       colorPalette[2],
      //       'Fraser',
      //       colorPalette[3],
      //       'Columbia',
      //       colorPalette[4],
      //       'Nelson',
      //       colorPalette[5],
      //       'St. Lawrence',
      //       colorPalette[6],
      //       'Saint John',
      //       colorPalette[7],
      //       //other
      //       '#A93226',
      //     ],
      //     'fill-opacity': 0.4,
      //     'fill-outline-color': 'black',
      //   }
      // });
      // map.addLayer({
      //   'id': 'Observatory',
      //   'source': 'observatorySource',
      //   'type': 'circle',
      //   // 'generateId': 'true',
      //   layout: {
      //     'visibility': 'visible'
      //   },
      //   paint: {
      //     'circle-color': [
      //       'match',
      //       ['get', 'BasinLocation'],
      //       'Yukon',
      //       colorPalette[0],
      //       'Mackenzie',
      //       colorPalette[1],
      //       'Churchill',
      //       colorPalette[2],
      //       'Fraser',
      //       colorPalette[3],
      //       'Columbia',
      //       colorPalette[4],
      //       'Nelson',
      //       colorPalette[5],
      //       'St. Lawrence',
      //       colorPalette[6],
      //       'Saint John',
      //       colorPalette[7],
      //       //other
      //       '#ccc'
      //     ],
      //     // 'circle-radius': 4,
      //     'circle-radius': {
      //       "stops": [
      //         [3, 4],
      //         // zoom is 5 -> circle radius will be 1px
      //         [5, 6],
      //         // zoom is 10 -> circle radius will be 2px
      //         [7, 8],
      //         [9, 10],
      //         [11, 12]
      //       ]
      //     },
      //     'circle-stroke-width': 2,
      //     'circle-stroke-color': 'black',
      //   }
      // });
    }

    //legend color palettes
    colorPalette0 = ['#5DADE2', '#73C6B6', '#b30086', '#F7DC6F', '#EB984E', '#A93226', '#884EA0', '#154360'];
    colorPalette1 = ['#7fc97f', '#beaed4', '#fdc086', '#ffff99', '#386cb0', '#f0027f', '#bf5b17', '#666666'];
    colorPalette2 = ['#1b9e77', '#d95f02', '#7570b3', '#e7298a', '#66a61e', '#e6ab02', '#a6761d', '#666666'];
    colorPalette3 = ['#a6cee3', '#1f78b4', '#b2df8a', '#33a02c', '#fb9a99', '#e31a1c', '#fdbf6f', '#ff7f00'];
    colorPalette4 = ['#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00', '#ffff33', '#a65628', '#f781bf'];
    colorPalette5 = ['#66c2a5', '#fc8d62', '#8da0cb', '#e78ac3', '#a6d854', '#ffd92f', '#e5c494', '#b3b3b3'];
    colorPalette6 = ['#8dd3c7', '#ffffb3', '#bebada', '#fb8072', '#80b1d3', '#fdb462', '#b3de69', '#fccde5'];
    colorPalette7 = ['#e41a1c', '#377eb8', '#4daf4a', '#984ea3', '#ff7f00', '#ffff33', '#fdbf6f', '#e7298a'];
    colorPalette = colorPalette7;

    //legend color update
    function legendColorUpdate() {
      document.getElementById("legendspan1").style.backgroundColor = colorPalette[0];
      document.getElementById("legendspan2").style.backgroundColor = colorPalette[1];
      document.getElementById("legendspan3").style.backgroundColor = colorPalette[2];
      document.getElementById("legendspan4").style.backgroundColor = colorPalette[3];
      document.getElementById("legendspan5").style.backgroundColor = colorPalette[4];
      document.getElementById("legendspan6").style.backgroundColor = colorPalette[5];
      document.getElementById("legendspan7").style.backgroundColor = colorPalette[6];
      document.getElementById("legendspan8").style.backgroundColor = colorPalette[7];
    }
    legendColorUpdate();

    // changinf basin fill colors
    function colorPaletteChange(c) {
      if (c == 1) {
        colorPalette = colorPalette1;
      } else if (c == 2) {
        colorPalette = colorPalette2;
      } else if (c == 3) {
        colorPalette = colorPalette3;
      } else if (c == 4) {
        colorPalette = colorPalette4;
      } else if (c == 5) {
        colorPalette = colorPalette5;
      } else if (c == 6) {
        colorPalette = colorPalette6;
      } else if (c == 7) {
        colorPalette = colorPalette7;
      }
      updateBasinDataColor();
      map.removeLayer("Basins");
      map.addLayer({
        'id': 'Basins',
        'type': 'fill',
        'source': 'basinSouce',
        'layout': {
          'visibility': 'visible'
        },
        'paint': {
          'fill-color': ['match',
            ['get', 'NAMRB_EN'],
            'Yukon',
            colorPalette[0],
            'Mackenzie',
            colorPalette[1],
            'Churchill',
            colorPalette[2],
            'Fraser',
            colorPalette[3],
            'Columbia',
            colorPalette[4],
            'Nelson',
            colorPalette[5],
            'St. Lawrence',
            colorPalette[6],
            'Saint John',
            colorPalette[7],
            //other
            '#A93226',
          ],
          'fill-opacity': basinFillOpacity,
          'fill-outline-color': 'black',
        }
      });
      map.removeLayer("Observatory");
      map.addLayer({
        'id': 'Observatory',
        'source': 'observatorySource',
        'type': 'circle',
        // 'generateId': 'true',
        layout: {
          'visibility': 'visible'
        },
        paint: {
          'circle-color': [
            'match',
            ['get', 'BasinLocation'],
            'Yukon',
            colorPalette[0],
            'Mackenzie',
            colorPalette[1],
            'Churchill',
            colorPalette[2],
            'Fraser',
            colorPalette[3],
            'Columbia',
            colorPalette[4],
            'Nelson',
            colorPalette[5],
            'St. Lawrence',
            colorPalette[6],
            'Saint John',
            colorPalette[7],
            //other
            '#ccc'
          ],
          // 'circle-radius': 4,
          'circle-radius': {
            "stops": [
              [3, 4],
              // zoom is 5 -> circle radius will be 1px
              [5, 6],
              // zoom is 10 -> circle radius will be 2px
              [7, 8],
              [9, 10],
              [11, 12]
            ]
          },
          'circle-stroke-width': 2,
          'circle-stroke-color': 'black',
        }
      });
      legendColorUpdate();
      // map.on('render', afterChangeComplete);
      displayFilteredList();
    }

    function closeNav() {
      document.getElementById("sidebar").style.display = "none";
      document.getElementById("closebtnContainer").style.display = "none";
    }

    // Holds visible observatory features for filtering
    var observatoryList = [];
    var basinObjects = {};
    var basinFillOpacity = 0.4;
    var observatoryView = 1;
    var projectView = 0;
    var listView = 1;
    var thumbnailView = 0;
    var numberOfBasins = 0;

    function hexToRGBa(h) {
      let r = 0,
        g = 0,
        b = 0;

      // 3 digits
      if (h.length == 4) {
        r = "0x" + h[1] + h[1];
        g = "0x" + h[2] + h[2];
        b = "0x" + h[3] + h[3];

        // 6 digits
      } else if (h.length == 7) {
        r = "0x" + h[1] + h[2];
        g = "0x" + h[3] + h[4];
        b = "0x" + h[5] + h[6];
      }

      return "rgba(" + +r + "," + +g + "," + +b + "," + basinFillOpacity + ")";
      // return [+r,+g,+b];
    }
    // console.log('RGB: ', hexToRGBa('#3d3d3d'));
    function hexToRGBaListHover(h, opac) {
      let r = 0,
        g = 0,
        b = 0;

      // 3 digits
      if (h.length == 4) {
        r = "0x" + h[1] + h[1];
        g = "0x" + h[2] + h[2];
        b = "0x" + h[3] + h[3];

        // 6 digits
      } else if (h.length == 7) {
        r = "0x" + h[1] + h[2];
        g = "0x" + h[3] + h[4];
        b = "0x" + h[5] + h[6];
      }

      return "rgba(" + +r + "," + +g + "," + +b + "," + opac + ")";
      // return [+r,+g,+b];
    }

    // Create a popup, but don't add it to the map yet.
    var popup = new mapboxgl.Popup({
      closeButton: false
    });

    var filterEl = document.getElementById('feature-filter');
    var listingEl = document.getElementById('feature-listing');

    // load basin geojson and put the name, coordinates and color into an object
    function getBasinData() {
      // load basin geojson and put the name, coordinates and color into an object
      $.getJSON("GWFbasins_v3.json", function(json) {
        // console.log(json); // show the JSON file content into console
        // console.log(json.features.length);
        // console.log(json.features[0].geometry.coordinates);
        // console.log(json.features[0].properties.NAMRB_EN);
        var x;
        for (x = 0; x < json.features.length; x++) {
          var colorchosen;
          if (json.features[x].properties.NAMRB_EN == 'Yukon') {
            colorchosen = colorPalette[0];
          } else if (json.features[x].properties.NAMRB_EN == 'Mackenzie') {
            colorchosen = colorPalette[1];
          } else if (json.features[x].properties.NAMRB_EN == 'Churchill') {
            colorchosen = colorPalette[2];
          } else if (json.features[x].properties.NAMRB_EN == 'Fraser') {
            colorchosen = colorPalette[3];
          } else if (json.features[x].properties.NAMRB_EN == 'Columbia') {
            colorchosen = colorPalette[4];
          } else if (json.features[x].properties.NAMRB_EN == 'Nelson') {
            colorchosen = colorPalette[5];
          } else if (json.features[x].properties.NAMRB_EN == 'St. Lawrence') {
            colorchosen = colorPalette[6];
          } else if (json.features[x].properties.NAMRB_EN == 'Saint John') {
            colorchosen = colorPalette[7];
          }
          basinObjects[x] = {
            'name': json.features[x].properties.NAMRB_EN,
            'color': colorchosen,
            'coordinates': json.features[x].geometry.coordinates
          };
        }
        numberOfBasins = x;
        console.log('Number of Basins: ', numberOfBasins);
        console.log('Basin objects: ', basinObjects);
      });
    }
    getBasinData();

    function updateBasinDataColor() {
      for (var x = 0; x < numberOfBasins; x++) {
        if (basinObjects[x].name == 'Yukon') {
          basinObjects[x].color = colorPalette[0];
        } else if (basinObjects[x].name == 'Mackenzie') {
          basinObjects[x].color = colorPalette[1];
        } else if (basinObjects[x].name == 'Churchill') {
          basinObjects[x].color = colorPalette[2];
        } else if (basinObjects[x].name == 'Fraser') {
          basinObjects[x].color = colorPalette[3];
        } else if (basinObjects[x].name == 'Columbia') {
          basinObjects[x].color = colorPalette[4];
        } else if (basinObjects[x].name == 'Nelson') {
          basinObjects[x].color = colorPalette[5];
        } else if (basinObjects[x].name == 'St. Lawrence') {
          basinObjects[x].color = colorPalette[6];
        } else if (basinObjects[x].name == 'Saint John') {
          basinObjects[x].color = colorPalette[7];
        }
      }
    }

    function inside(point, poly) {
      // ray-casting algorithm based on
      // http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html
      var x = point[0],
        y = point[1];
      var inside = false;
      for (var i = 0, j = poly.length - 1; i < poly.length; j = i++) {
        var xi = poly[i][0],
          yi = poly[i][1];
        var xj = poly[j][0],
          yj = poly[j][1];
        var intersect = ((yi > y) != (yj > y)) &&
          (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    };

    function sortWithIndeces(toSort) {
      for (var i = 0; i < toSort.length; i++) {
        toSort[i] = [toSort[i], i];
      }
      toSort.sort(function(left, right) {
        return left[0] < right[0] ? -1 : 1;
      });
      toSort.sortIndices = [];
      for (var j = 0; j < toSort.length; j++) {
        toSort.sortIndices.push(toSort[j][1]);
        toSort[j] = toSort[j][0];
      }
      return toSort;
    }

    function showObservatoryView() {
      observatoryView = 1;
      projectView = 0;
      $('#projectViewButton').css('background-color', 'rgba(145,145,145,0.7)');
      $('#observatoryViewButton').css('background-color', 'rgba(221,221,221,0.7)');
      document.getElementById("projectViewButton").style.fontWeight = 'normal';
      document.getElementById("observatoryViewButton").style.fontWeight = 'bold';
      document.getElementById("observatoryViewButton").style.borderBottom = "thin solid #3d3d3d";
      document.getElementById("projectViewButton").style.borderBottom = "none";
      displayFilteredList();
    }

    function showProjectView() {
      observatoryView = 0;
      projectView = 1;
      $('#observatoryViewButton').css('background-color', 'rgba(145,145,145,0.7)');
      $('#projectViewButton').css('background-color', 'rgba(221,221,221,0.7)');
      document.getElementById("projectViewButton").style.fontWeight = 'bold';
      document.getElementById("observatoryViewButton").style.fontWeight = 'normal';
      document.getElementById("projectViewButton").style.borderBottom = "thin solid black";
      document.getElementById("observatoryViewButton").style.borderBottom = "none";
      displayFilteredList();
    }

    function showListView() {
      listView = 1;
      thumbnailView = 0;
      document.getElementById("listViewButtonLines1").style.backgroundColor = 'black';
      document.getElementById("listViewButtonLines2").style.backgroundColor = 'black';
      document.getElementById("listViewButtonLines3").style.backgroundColor = 'black';
      document.getElementById("listViewButtonLines4").style.backgroundColor = 'black';
      document.getElementById("thumbnailViewButtonBoxes1").style.backgroundColor = 'white';
      document.getElementById("thumbnailViewButtonBoxes2").style.backgroundColor = 'white';
      document.getElementById("thumbnailViewButtonBoxes3").style.backgroundColor = 'white';
      document.getElementById("thumbnailViewButtonBoxes4").style.backgroundColor = 'white';
      displayFilteredList();
    }

    function showThumbnailView() {
      listView = 0;
      thumbnailView = 1;
      document.getElementById("listViewButtonLines1").style.backgroundColor = 'white';
      document.getElementById("listViewButtonLines2").style.backgroundColor = 'white';
      document.getElementById("listViewButtonLines3").style.backgroundColor = 'white';
      document.getElementById("listViewButtonLines4").style.backgroundColor = 'white';
      document.getElementById("thumbnailViewButtonBoxes1").style.backgroundColor = 'black';
      document.getElementById("thumbnailViewButtonBoxes2").style.backgroundColor = 'black';
      document.getElementById("thumbnailViewButtonBoxes3").style.backgroundColor = 'black';
      document.getElementById("thumbnailViewButtonBoxes4").style.backgroundColor = 'black';
      displayFilteredList();
    }

    function getListingImage(sitename) {
      if (sitename == "Havikpak Creek") {
        return "images/Havikpak Creek.jpg"
      } else if (sitename == "Trail Valley Creek") {
        return "images/Trail Valley Creek.jpg"
      } else if (sitename == "Baker Creek") {
        return "images/Baker Creek.jpg"
      } else if (sitename == "Boreal Ecosystem Research and Monitoring Sites (BERMS), White Gull Creek, SK") {
        return "images/BERMS 1.PNG"
      } else if (sitename == "Brintnell-Bologna Icefield") {
        return "images/Brintnell-Bologna Icefield.jpg"
      } else if (sitename == "Columbia Icefield") {
        return "images/Columbia Icefield.jpg"
      } else if (sitename == "Kenaston/Brightwater Creek Mesonet Site") {
        return "images/Kenaston.jpg"
      } else if (sitename == "Lake O'Hara") {
        return "images/Lake OHara 1.PNG"
      } else if (sitename == "Marmot Creek Research Basin") {
        return "images/Marmot Creek.jpg"
      } else if (sitename == "Scotty Creek") {
        return "images/Scotty Creek.jpg"
      } else if (sitename == "St. Denis National Wildlife Area") {
        return "images/St Denis.jpg"
      } else if (sitename == "Wapta Icefield/Peyto Glacier") {
        return "images/Wapta Icefield.jpg"
      } else if (sitename == "West Nose Creek") {
        return "images/West Nose Creek.PNG"
      } else if (sitename == "Wolf Creek Research Basin") {
        return "images/Wolf Creek.jpg"
      } else {
        return "images/dummy.jpg"
      }
    }

    function renderListings(features) {
      document.getElementById("closebtnContainer").style.display = "none";
      var empty = document.createElement('p');
      // Clear any existing listings
      listingEl.innerHTML = '';

      if(observatoryView == 1){
        document.getElementById("feature-filter").placeholder = "Filter results by observatory name";
        if (features.length) {
          if (thumbnailView == 1) {
            //update the view icon colors
            document.getElementById("listViewButtonLines1").style.backgroundColor = 'white';
            document.getElementById("listViewButtonLines2").style.backgroundColor = 'white';
            document.getElementById("listViewButtonLines3").style.backgroundColor = 'white';
            document.getElementById("listViewButtonLines4").style.backgroundColor = 'white';
            document.getElementById("thumbnailViewButtonBoxes1").style.backgroundColor = 'black';
            document.getElementById("thumbnailViewButtonBoxes2").style.backgroundColor = 'black';
            document.getElementById("thumbnailViewButtonBoxes3").style.backgroundColor = 'black';
            document.getElementById("thumbnailViewButtonBoxes4").style.backgroundColor = 'black';

            features.forEach(function(feature) {
              var itemColor = "";
              // console.log(feature);
              var prop = feature.properties;
              var divItem = document.createElement('div');
              divItem.className = "divContainer";
              var divImgItem = document.createElement('div');
              divImgItem.className = "divImgContainer";
              var divNameItem = document.createElement('div');
              divNameItem.className = "divNameContainer";
              var divTextItem = document.createElement('div');
              divTextItem.className = "divTextContainer";
              var imgItem = document.createElement('img');
              imgItem.src = getListingImage(prop.Site);
              imgItem.className = "divImg";
              var nameItem = document.createElement('a');
              nameItem.target = '_blank';
              nameItem.textContent = prop.Site;
              var textItem = document.createElement('div');
              textItem.className = "divText";
              textItem.innerHTML = "Click to view details";

              if (map.getLayoutProperty('Basins', 'visibility') == 'visible') {
                if (prop.BasinLocation == 'Yukon') {
                  divItem.style.backgroundColor = hexToRGBa(colorPalette[0]);
                  itemColor = hexToRGBa(colorPalette[0]);
                } else if (prop.BasinLocation == 'Mackenzie') {
                  divItem.style.backgroundColor = hexToRGBa(colorPalette[1]);
                  itemColor = hexToRGBa(colorPalette[1]);
                } else if (prop.BasinLocation == 'Churchill') {
                  divItem.style.backgroundColor = hexToRGBa(colorPalette[2]);
                  itemColor = hexToRGBa(colorPalette[2]);
                } else if (prop.BasinLocation == 'Fraser') {
                  divItem.style.backgroundColor = hexToRGBa(colorPalette[3]);
                  itemColor = hexToRGBa(colorPalette[3]);
                } else if (prop.BasinLocation == 'Columbia') {
                  divItem.style.backgroundColor = hexToRGBa(colorPalette[4]);
                  itemColor = hexToRGBa(colorPalette[4]);
                } else if (prop.BasinLocation == 'Nelson') {
                  divItem.style.backgroundColor = hexToRGBa(colorPalette[5]);
                  itemColor = hexToRGBa(colorPalette[5]);
                } else if (prop.BasinLocation == 'St. Lawrence') {
                  divItem.style.backgroundColor = hexToRGBa(colorPalette[6]);
                  itemColor = hexToRGBa(colorPalette[6]);
                } else if (prop.BasinLocation == 'Saint John') {
                  divItem.style.backgroundColor = hexToRGBa(colorPalette[7]);
                  itemColor = hexToRGBa(colorPalette[7]);
                } else {
                  divItem.style.backgroundColor = '#ccc';
                  itemColor = hexToRGBa('#ccc');
                }
              }

              divItem.addEventListener('mouseover', function() {
                // divItem.style.backgroundColor = '#a9a9a9';
                divItem.style.opacity = .9;
                // Highlight corresponding feature on the map
                popup
                  .setLngLat(feature.geometry.coordinates)
                  .setText(feature.properties.Site)
                  .addTo(map);
              });
              divItem.addEventListener('mouseleave', function() {
                // divItem.style.backgroundColor = '#fff';
                divItem.style.opacity = 1;
                popup.remove();
              });
              var divItemDetailsON = 0;
              divItem.addEventListener('click', function() {
                if (divItemDetailsON == 0) {
                  divItemDetailsON = 1;
                  divItem.style.width = '95%';
                  divItem.style.height = 'auto';
                  divImgItem.style.height = '200px';
                  imgItem.style.height = '200px';
                  divItem.removeChild(divItem.lastChild);

                  var divItemDetails = document.createElement('div');
                  divItemDetails.className = "divItemDetailsContainer";
                  // var divImgItemDetails = document.createElement('div');
                  // divImgItemDetails.className = "divImgDetailsContainer";
                  var divOverviewItemDetails = document.createElement('div');
                  divOverviewItemDetails.className = "divNameDetailsContainer";
                  var divFocusItemDetails = document.createElement('div');
                  divFocusItemDetails.className = "divTextDetailsContainer";
                  // var imgItemDetails = document.createElement('img');
                  // imgItemDetails.src = getListingImage(prop.Site);
                  // imgItemDetails.className = "divImgDetails";
                  var divProjectItemDetails = document.createElement('div');
                  divProjectItemDetails.className = "divProjectDetailsContainer";

                  var overviewItemDetails = document.createElement('p');
                  overviewItemDetails.innerHTML = "<b>Overview:</b><br><br>" + prop.Overview;
                  // var overviewItemDetails = document.createElement('a');
                  // overviewItemDetails.target = '_blank';
                  // overviewItemDetails.textContent = 'Overview';

                  var divTextItem = document.createElement('div');
                  divTextItem.className = "divTextContainer";
                  var textItem = document.createElement('div');
                  textItem.className = "divText";
                  textItem.innerHTML = "Click to Collapse";
                  divTextItem.style.transform = 'translate(0, -145px)';

                  // var focusItemDetails = document.createElement('div');
                  // focusItemDetails.className = "divFocusDetails";
                  // focusItemDetails.innerHTML = "Other details"

                  var focusItemDetails = document.createElement('div');
                  focusItemDetails.className = "divFocusDetails";
                  var focusString = prop.CurrentScienceFocusandInstrumentation.split(";");
                  var focusList = document.createElement("ul");
                  for (var s = 0; s < focusString.length; s++) {
                    var anchor = document.createElement("p");
                    anchor.innerHTML = focusString[s];
                    var elem = document.createElement("li");
                    elem.appendChild(anchor);
                    focusList.appendChild(elem);
                  }
                  focusItemDetails.innerHTML = "<b>Current Science Focus and Instrumentation</b>";
                  focusItemDetails.appendChild(focusList);

                  var projectItemDetails = document.createElement('div');
                  projectItemDetails.className = "divProjectDetails";
                  var projectString = prop.Projects.split(";");
                  var projectList = document.createElement("ul");
                  console.log(projectString);
                  if (projectString.length > 0) {
                    for (var p = 0; p < projectString.length; p++) {
                      var anchor = document.createElement("p");
                      anchor.innerHTML = projectString[p];
                      var elem = document.createElement("li");
                      elem.appendChild(anchor);
                      projectList.appendChild(elem);
                    }
                    projectItemDetails.innerHTML = "<b>Project(s)</b>";
                    projectItemDetails.appendChild(projectList);
                  }

                  divTextItem.appendChild(textItem);
                  divItem.appendChild(divTextItem);
                  // // divImgItemDetails.appendChild(imgItemDetails);
                  // divOverviewItemDetails.appendChild(overviewItemDetails);
                  // divFocusItemDetails.appendChild(focusItemDetails);
                  // // divItemDetails.appendChild(divImgItemDetails);
                  // divItemDetails.appendChild(divOverviewItemDetails);
                  // divItemDetails.appendChild(divFocusItemDetails);

                  divOverviewItemDetails.appendChild(overviewItemDetails);
                  divFocusItemDetails.appendChild(focusItemDetails);
                  divProjectItemDetails.appendChild(projectItemDetails)
                  divItemDetails.appendChild(divOverviewItemDetails);
                  divItemDetails.appendChild(divFocusItemDetails);
                  divItemDetails.appendChild(divProjectItemDetails);

                  divItem.appendChild(divItemDetails);
                } else if (divItemDetailsON == 1) {
                  divItemDetailsON = 0;
                  divItem.style.width = '45%';
                  divItem.style.height = '150px';
                  divImgItem.style.height = '120px';
                  imgItem.style.height = '120px';
                  divItem.removeChild(divItem.lastChild);
                  divItem.removeChild(divItem.lastChild);
                  // divItemDetails.innerHTML = '';
                  var divTextItem = document.createElement('div');
                  divTextItem.className = "divTextContainer";
                  var textItem = document.createElement('div');
                  textItem.className = "divText";
                  textItem.innerHTML = "Click to View";
                  divTextItem.appendChild(textItem);
                  divItem.appendChild(divTextItem);
                }
              });
              // divItem.appendChild(imgItem);
              divImgItem.appendChild(imgItem);
              divNameItem.appendChild(nameItem);
              divTextItem.appendChild(textItem);
              divItem.appendChild(divImgItem);
              divItem.appendChild(divNameItem);
              divItem.appendChild(divTextItem);
              listingEl.appendChild(divItem);
            });

            //add a dummy div at the last of the listing div
            var divListItem = document.createElement('div');
            divListItem.className = "divListContainer";
            divListItem.style.borderBottom = "none";
            var divDummy = document.createElement('div');
            divDummy.className = "dummyDiv";
            divListItem.appendChild(divDummy);
            listingEl.appendChild(divListItem);
          }
          // adding listview with a span on the right matching the basin layer
          if (listView == 1) {
            //update the view icon colors
            document.getElementById("listViewButtonLines1").style.backgroundColor = 'black';
            document.getElementById("listViewButtonLines2").style.backgroundColor = 'black';
            document.getElementById("listViewButtonLines3").style.backgroundColor = 'black';
            document.getElementById("listViewButtonLines4").style.backgroundColor = 'black';
            document.getElementById("thumbnailViewButtonBoxes1").style.backgroundColor = 'white';
            document.getElementById("thumbnailViewButtonBoxes2").style.backgroundColor = 'white';
            document.getElementById("thumbnailViewButtonBoxes3").style.backgroundColor = 'white';
            document.getElementById("thumbnailViewButtonBoxes4").style.backgroundColor = 'white';

            features.forEach(function(feature) {
              var itemColor = "";
              // console.log('observatory feature names: ', feature.properties.Site);
              var prop = feature.properties;
              var divListItem = document.createElement('div');
              divListItem.className = "divListContainer";
              var item = document.createElement('a');
              var spanListItem = document.createElement('span');
              // item.href = prop.wikipedia;
              item.target = '_blank';
              item.textContent = prop.Site;
              // if (item.textContent == ""){
              //   item.textContent = feature._vectorTileFeature["Site"];
              // }
              if (map.getLayoutProperty('Basins', 'visibility') == 'visible') {
                if (prop.BasinLocation == 'Yukon') {
                  spanListItem.style.backgroundColor = colorPalette[0];
                  itemColor = hexToRGBa(colorPalette[0]);
                } else if (prop.BasinLocation == 'Mackenzie') {
                  spanListItem.style.backgroundColor = colorPalette[1];
                  itemColor = hexToRGBa(colorPalette[1]);
                } else if (prop.BasinLocation == 'Churchill') {
                  spanListItem.style.backgroundColor = colorPalette[2];
                  itemColor = hexToRGBa(colorPalette[2]);
                } else if (prop.BasinLocation == 'Fraser') {
                  spanListItem.style.backgroundColor = colorPalette[3];
                  itemColor = hexToRGBa(colorPalette[3]);
                } else if (prop.BasinLocation == 'Columbia') {
                  spanListItem.style.backgroundColor = colorPalette[4];
                  itemColor = hexToRGBa(colorPalette[4]);
                } else if (prop.BasinLocation == 'Nelson') {
                  spanListItem.style.backgroundColor = colorPalette[5];
                  itemColor = hexToRGBa(colorPalette[5]);
                } else if (prop.BasinLocation == 'St. Lawrence') {
                  spanListItem.style.backgroundColor = colorPalette[6];
                  itemColor = hexToRGBa(colorPalette[6]);
                } else if (prop.BasinLocation == 'Saint John') {
                  spanListItem.style.backgroundColor = colorPalette[7];
                  itemColor = hexToRGBa(colorPalette[7]);
                } else {
                  spanListItem.style.backgroundColor = '#ccc';
                  itemColor = hexToRGBa('#ccc');
                }
              }

              divListItem.addEventListener('mouseover', function() {
                // Highlight corresponding feature on the map
                // item.style.opacity = .9;
                divListItem.style.backgroundColor = hexToRGBaListHover("#dddddd", 0.5);
                item.style.cursor = 'pointer';
                popup
                  .setLngLat(feature.geometry.coordinates)
                  .setText(feature.properties.Site)
                  .addTo(map);
              });
              divListItem.addEventListener('mouseleave', function() {
                popup.remove();
                // item.style.opacity = 1;
                divListItem.style.backgroundColor = hexToRGBaListHover("#dddddd", 0);;
              });
              var divItemDetailsON = 0;
              divListItem.addEventListener('click', function() {
                if (divItemDetailsON == 0) {
                  divItemDetailsON = 1;
                  var divItemDetails = document.createElement('div');
                  divItemDetails.className = "divItemDetailsContainer";
                  divItemDetails.style.backgroundColor = itemColor;

                  var divImgItemDetails = document.createElement('div');
                  divImgItemDetails.className = "divImgDetailsContainer";
                  var divOverviewItemDetails = document.createElement('div');
                  divOverviewItemDetails.className = "divNameDetailsContainer";
                  var divFocusItemDetails = document.createElement('div');
                  divFocusItemDetails.className = "divTextDetailsContainer";
                  var divProjectItemDetails = document.createElement('div');
                  divProjectItemDetails.className = "divProjectDetailsContainer";

                  var imgItemDetails = document.createElement('img');
                  imgItemDetails.src = getListingImage(prop.Site);
                  imgItemDetails.className = "divImgDetails";

                  var overviewItemDetails = document.createElement('p');
                  overviewItemDetails.innerHTML = "<b>Overview:</b><br><br>" + prop.Overview;

                  var focusItemDetails = document.createElement('div');
                  focusItemDetails.className = "divFocusDetails";
                  var focusString = prop.CurrentScienceFocusandInstrumentation.split(";");
                  var focusList = document.createElement("ul");
                  for (var s = 0; s < focusString.length; s++) {
                    var anchor = document.createElement("p");
                    anchor.innerHTML = focusString[s];
                    var elem = document.createElement("li");
                    elem.appendChild(anchor);
                    focusList.appendChild(elem);
                  }
                  focusItemDetails.innerHTML = "<b>Current Science Focus and Instrumentation</b>";
                  focusItemDetails.appendChild(focusList);

                  var projectItemDetails = document.createElement('div');
                  projectItemDetails.className = "divProjectDetails";
                  var projectString = prop.Projects.split(";");
                  var projectList = document.createElement("ul");
                  if (projectString.length > 0) {
                    for (var p = 0; p < projectString.length; p++) {
                      var anchor = document.createElement("p");
                      anchor.innerHTML = projectString[p];
                      var elem = document.createElement("li");
                      elem.appendChild(anchor);
                      projectList.appendChild(elem);
                    }
                    projectItemDetails.innerHTML = "<b>Project(s)</b>";
                    projectItemDetails.appendChild(projectList);
                  }

                  divImgItemDetails.appendChild(imgItemDetails);
                  divOverviewItemDetails.appendChild(overviewItemDetails);
                  divFocusItemDetails.appendChild(focusItemDetails);
                  divProjectItemDetails.appendChild(projectItemDetails)
                  divItemDetails.appendChild(divImgItemDetails);
                  divItemDetails.appendChild(divOverviewItemDetails);
                  divItemDetails.appendChild(divFocusItemDetails);
                  divItemDetails.appendChild(divProjectItemDetails);

                  item.appendChild(divItemDetails);
                  // divListItem.removeChild(spanListItem);
                } else if (divItemDetailsON == 1) {
                  divItemDetailsON = 0;
                  // divListItem.appendChild(spanListItem);
                  item.removeChild(item.lastChild);
                  // divItemDetails.innerHTML = '';
                }
              });

              divListItem.appendChild(spanListItem);
              divListItem.appendChild(item);
              listingEl.appendChild(divListItem);
            });

            //add a dummy div at the last of the listing div
            var divListItem = document.createElement('div');
            divListItem.className = "divListContainer";
            divListItem.style.borderBottom = "none";
            var divDummy = document.createElement('div');
            divDummy.className = "dummyDiv";
            divListItem.appendChild(divDummy);
            listingEl.appendChild(divListItem);
          }

          document.getElementById("listViewButton").style.display = "block";
          document.getElementById("thumbnailViewButton").style.display = "block";
          document.getElementById("observatoryViewButton").style.display = "block";
          document.getElementById("projectViewButton").style.display = "block";

          // Show the filter input
          filterEl.parentNode.style.display = 'block';
        } else if (features.length === 0 && filterEl.value !== '') {
          empty.textContent = 'No results found';
          listingEl.appendChild(empty);
        } else {
          empty.textContent = 'Drag the map to populate results';
          listingEl.appendChild(empty);

          // Hide the filter input
          filterEl.parentNode.style.display = 'none';

          // remove features filter
          map.setFilter('Observatory', ['has', 'Site']);
        }
      }
      else if(projectView == 1){
        document.getElementById("feature-filter").placeholder = "Filter results by project name";
        if (features.length) {
          if (thumbnailView == 1) {
            //update the view icon colors
            document.getElementById("listViewButtonLines1").style.backgroundColor = 'white';
            document.getElementById("listViewButtonLines2").style.backgroundColor = 'white';
            document.getElementById("listViewButtonLines3").style.backgroundColor = 'white';
            document.getElementById("listViewButtonLines4").style.backgroundColor = 'white';
            document.getElementById("thumbnailViewButtonBoxes1").style.backgroundColor = 'black';
            document.getElementById("thumbnailViewButtonBoxes2").style.backgroundColor = 'black';
            document.getElementById("thumbnailViewButtonBoxes3").style.backgroundColor = 'black';
            document.getElementById("thumbnailViewButtonBoxes4").style.backgroundColor = 'black';

            features.forEach(function(feature) {
              var itemColor = "";
              // console.log(feature);
              var prop = feature.properties;
              var divItem = document.createElement('div');
              divItem.className = "divContainer";
              var divImgItem = document.createElement('div');
              divImgItem.className = "divImgContainer";
              var divNameItem = document.createElement('div');
              divNameItem.className = "divNameContainer";
              var divTextItem = document.createElement('div');
              divTextItem.className = "divTextContainer";
              var imgItem = document.createElement('img');
              imgItem.src = getListingImage(prop.ProjectName);
              imgItem.className = "divImg";
              var nameItem = document.createElement('a');
              nameItem.target = '_blank';
              nameItem.textContent = prop.ProjectName;
              var textItem = document.createElement('div');
              textItem.className = "divText";
              textItem.innerHTML = "Click to view details";

              // if (map.getLayoutProperty('Basins', 'visibility') == 'visible') {
              //   if (prop.BasinLocation == 'Yukon') {
              //     divItem.style.backgroundColor = hexToRGBa(colorPalette[0]);
              //     itemColor = hexToRGBa(colorPalette[0]);
              //   } else if (prop.BasinLocation == 'Mackenzie') {
              //     divItem.style.backgroundColor = hexToRGBa(colorPalette[1]);
              //     itemColor = hexToRGBa(colorPalette[1]);
              //   } else if (prop.BasinLocation == 'Churchill') {
              //     divItem.style.backgroundColor = hexToRGBa(colorPalette[2]);
              //     itemColor = hexToRGBa(colorPalette[2]);
              //   } else if (prop.BasinLocation == 'Fraser') {
              //     divItem.style.backgroundColor = hexToRGBa(colorPalette[3]);
              //     itemColor = hexToRGBa(colorPalette[3]);
              //   } else if (prop.BasinLocation == 'Columbia') {
              //     divItem.style.backgroundColor = hexToRGBa(colorPalette[4]);
              //     itemColor = hexToRGBa(colorPalette[4]);
              //   } else if (prop.BasinLocation == 'Nelson') {
              //     divItem.style.backgroundColor = hexToRGBa(colorPalette[5]);
              //     itemColor = hexToRGBa(colorPalette[5]);
              //   } else if (prop.BasinLocation == 'St. Lawrence') {
              //     divItem.style.backgroundColor = hexToRGBa(colorPalette[6]);
              //     itemColor = hexToRGBa(colorPalette[6]);
              //   } else if (prop.BasinLocation == 'Saint John') {
              //     divItem.style.backgroundColor = hexToRGBa(colorPalette[7]);
              //     itemColor = hexToRGBa(colorPalette[7]);
              //   } else {
              //     divItem.style.backgroundColor = '#ccc';
              //     itemColor = hexToRGBa('#ccc');
              //   }
              // }

              divItem.addEventListener('mouseover', function() {
                // divItem.style.backgroundColor = '#a9a9a9';
                divItem.style.opacity = .9;
                // Highlight corresponding feature on the map
                // popup
                //   .setLngLat(feature.geometry.coordinates)
                //   .setText(feature.properties.Site)
                //   .addTo(map);
                if(prop.NumberofSites == 1){
                  new mapboxgl.Popup({
                    closeButton: false,
                    className: 'projectPopups'
                  }).setLngLat(feature.geometry.coordinates)
                    .setText(feature.properties.Site)
                    .addTo(map);
                }
                else if(prop.NumberofSites > 1){
                  var projectSiteNames = feature.properties.Site.split(";");
                  for(var pop = 0; pop < prop.NumberofSites; pop++){
                    new mapboxgl.Popup({
                      closeButton: false,
                      className: 'projectPopups'
                    }).setLngLat(feature.geometry.coordinates[pop])
                      .setText(projectSiteNames[pop])
                      .addTo(map);
                  }
                }
              });
              divItem.addEventListener('mouseleave', function() {
                // divItem.style.backgroundColor = '#fff';
                divItem.style.opacity = 1;
                $('.projectPopups').remove();
              });
              var divItemDetailsON = 0;
              divItem.addEventListener('click', function() {
                if (divItemDetailsON == 0) {
                  divItemDetailsON = 1;
                  divItem.style.width = '95%';
                  divItem.style.height = 'auto';
                  divImgItem.style.height = '200px';
                  imgItem.style.height = '200px';
                  divItem.removeChild(divItem.lastChild);

                  var divItemDetails = document.createElement('div');
                  divItemDetails.className = "divItemDetailsContainer";
                  // var divImgItemDetails = document.createElement('div');
                  // divImgItemDetails.className = "divImgDetailsContainer";
                  var divOverviewItemDetails = document.createElement('div');
                  divOverviewItemDetails.className = "divNameDetailsContainer";
                  var divFocusItemDetails = document.createElement('div');
                  divFocusItemDetails.className = "divTextDetailsContainer";
                  var divCoIItemDetails = document.createElement('div');
                  divCoIItemDetails.className = "divCoIDetailsContainer";
                  var divProjectItemDetails = document.createElement('div');
                  divProjectItemDetails.className = "divProjectDetailsContainer";
                  var divLinkItemDetails = document.createElement('div');
                  divLinkItemDetails.className = "divLinkDetailsContainer";

                  var overviewItemDetails = document.createElement('p');
                  overviewItemDetails.innerHTML = "<b>Overview:</b><br><br>" + prop.Overview;

                  var divTextItem = document.createElement('div');
                  divTextItem.className = "divTextContainer";
                  var textItem = document.createElement('div');
                  textItem.className = "divText";
                  textItem.innerHTML = "Click to Collapse";
                  divTextItem.style.transform = 'translate(0, -145px)';

                  var focusItemDetails = document.createElement('div');
                  focusItemDetails.className = "divFocusDetails";
                  focusItemDetails.innerHTML = "<b>Principal Investigator</b>: <br><br>" + prop.PI.split(";")[0] + "<br><br>";

                  var coIItemDetails = document.createElement('div');
                  coIItemDetails.className = "divcoIDetails";
                  var coIString = prop.CoI.split(";");
                  var coIList = document.createElement("ul");
                  if (coIString.length > 1) {
                    for (var c = 0; c < coIString.length; c++) {
                      var anchor = document.createElement("p");
                      anchor.innerHTML = coIString[c];
                      var elem = document.createElement("li");
                      elem.appendChild(anchor);
                      coIList.appendChild(elem);
                    }
                    coIItemDetails.innerHTML = "<b>Co-Investigator(s)</b>";
                    coIItemDetails.appendChild(coIList);
                  }

                  var projectItemDetails = document.createElement('div');
                  projectItemDetails.className = "divProjectDetails";
                  var projectString = prop.Site.split(";");
                  var projectList = document.createElement("ul");
                  if (projectString.length > 0) {
                    for (var p = 0; p < projectString.length; p++) {
                      var anchor = document.createElement("p");
                      anchor.innerHTML = projectString[p];
                      var elem = document.createElement("li");
                      elem.appendChild(anchor);
                      projectList.appendChild(elem);
                    }
                    projectItemDetails.innerHTML = "<b>Site(s)</b>";
                    projectItemDetails.appendChild(projectList);
                  }

                  var LinkItemDetails = document.createElement('a');
                  LinkItemDetails.target = '_blank';
                  LinkItemDetails.href = prop.URL;
                  LinkItemDetails.textContent = "\tMore Info";

                  divTextItem.appendChild(textItem);
                  divItem.appendChild(divTextItem);
                  // // divImgItemDetails.appendChild(imgItemDetails);
                  // divOverviewItemDetails.appendChild(overviewItemDetails);
                  // divFocusItemDetails.appendChild(focusItemDetails);
                  // // divItemDetails.appendChild(divImgItemDetails);
                  // divItemDetails.appendChild(divOverviewItemDetails);
                  // divItemDetails.appendChild(divFocusItemDetails);

                  divOverviewItemDetails.appendChild(overviewItemDetails);
                  divFocusItemDetails.appendChild(focusItemDetails);
                  divCoIItemDetails.appendChild(coIItemDetails);
                  divProjectItemDetails.appendChild(projectItemDetails);
                  divLinkItemDetails.appendChild(LinkItemDetails);

                  divItemDetails.appendChild(divOverviewItemDetails);
                  divItemDetails.appendChild(divFocusItemDetails);
                  divItemDetails.appendChild(divCoIItemDetails);
                  divItemDetails.appendChild(divProjectItemDetails);
                  divItemDetails.appendChild(divLinkItemDetails);

                  divItem.appendChild(divItemDetails);
                } else if (divItemDetailsON == 1) {
                  divItemDetailsON = 0;
                  divItem.style.width = '45%';
                  divItem.style.height = '150px';
                  divImgItem.style.height = '120px';
                  imgItem.style.height = '120px';
                  divItem.removeChild(divItem.lastChild);
                  divItem.removeChild(divItem.lastChild);
                  // divItemDetails.innerHTML = '';
                  var divTextItem = document.createElement('div');
                  divTextItem.className = "divTextContainer";
                  var textItem = document.createElement('div');
                  textItem.className = "divText";
                  textItem.innerHTML = "Click to View";
                  divTextItem.appendChild(textItem);
                  divItem.appendChild(divTextItem);
                }
              });
              // divItem.appendChild(imgItem);
              divImgItem.appendChild(imgItem);
              divNameItem.appendChild(nameItem);
              divTextItem.appendChild(textItem);
              divItem.appendChild(divImgItem);
              divItem.appendChild(divNameItem);
              divItem.appendChild(divTextItem);
              listingEl.appendChild(divItem);
            });

            //add a dummy div at the last of the listing div
            var divListItem = document.createElement('div');
            divListItem.className = "divListContainer";
            divListItem.style.borderBottom = "none";
            var divDummy = document.createElement('div');
            divDummy.className = "dummyDiv";
            divListItem.appendChild(divDummy);
            listingEl.appendChild(divListItem);
          }
          // adding listview with a span on the right matching the basin layer
          if (listView == 1) {
            //update the view icon colors
            document.getElementById("listViewButtonLines1").style.backgroundColor = 'black';
            document.getElementById("listViewButtonLines2").style.backgroundColor = 'black';
            document.getElementById("listViewButtonLines3").style.backgroundColor = 'black';
            document.getElementById("listViewButtonLines4").style.backgroundColor = 'black';
            document.getElementById("thumbnailViewButtonBoxes1").style.backgroundColor = 'white';
            document.getElementById("thumbnailViewButtonBoxes2").style.backgroundColor = 'white';
            document.getElementById("thumbnailViewButtonBoxes3").style.backgroundColor = 'white';
            document.getElementById("thumbnailViewButtonBoxes4").style.backgroundColor = 'white';

            features.forEach(function(feature) {
              var itemColor = "";
              // console.log('observatory feature names: ', feature.properties.Site);
              var prop = feature.properties;
              var divListItem = document.createElement('div');
              divListItem.className = "divListContainer";
              var item = document.createElement('a');
              // var spanListItem = document.createElement('span');
              item.target = '_blank';
              item.textContent = prop.ProjectName;
              // if (map.getLayoutProperty('Basins', 'visibility') == 'visible') {
              //   if (prop.BasinLocation == 'Yukon') {
              //     spanListItem.style.backgroundColor = colorPalette[0];
              //     itemColor = hexToRGBa(colorPalette[0]);
              //   } else if (prop.BasinLocation == 'Mackenzie') {
              //     spanListItem.style.backgroundColor = colorPalette[1];
              //     itemColor = hexToRGBa(colorPalette[1]);
              //   } else if (prop.BasinLocation == 'Churchill') {
              //     spanListItem.style.backgroundColor = colorPalette[2];
              //     itemColor = hexToRGBa(colorPalette[2]);
              //   } else if (prop.BasinLocation == 'Fraser') {
              //     spanListItem.style.backgroundColor = colorPalette[3];
              //     itemColor = hexToRGBa(colorPalette[3]);
              //   } else if (prop.BasinLocation == 'Columbia') {
              //     spanListItem.style.backgroundColor = colorPalette[4];
              //     itemColor = hexToRGBa(colorPalette[4]);
              //   } else if (prop.BasinLocation == 'Nelson') {
              //     spanListItem.style.backgroundColor = colorPalette[5];
              //     itemColor = hexToRGBa(colorPalette[5]);
              //   } else if (prop.BasinLocation == 'St. Lawrence') {
              //     spanListItem.style.backgroundColor = colorPalette[6];
              //     itemColor = hexToRGBa(colorPalette[6]);
              //   } else if (prop.BasinLocation == 'Saint John') {
              //     spanListItem.style.backgroundColor = colorPalette[7];
              //     itemColor = hexToRGBa(colorPalette[7]);
              //   } else {
              //     spanListItem.style.backgroundColor = '#ccc';
              //     itemColor = hexToRGBa('#ccc');
              //   }
              //
              // }

              divListItem.addEventListener('mouseover', function() {
                // Highlight corresponding feature on the map
                // item.style.opacity = .9;
                divListItem.style.backgroundColor = hexToRGBaListHover("#dddddd", 0.5);
                item.style.cursor = 'pointer';
                // console.log(feature.geometry.coordinates);
                if(prop.NumberofSites == 1){
                  new mapboxgl.Popup({
                    closeButton: false,
                    className: 'projectPopups'
                  }).setLngLat(feature.geometry.coordinates)
                    .setText(feature.properties.Site)
                    .addTo(map);
                }
                else if(prop.NumberofSites > 1){
                  var projectSiteNames = feature.properties.Site.split(";");
                  for(var pop = 0; pop < prop.NumberofSites; pop++){
                    new mapboxgl.Popup({
                      closeButton: false,
                      className: 'projectPopups'
                    }).setLngLat(feature.geometry.coordinates[pop])
                      .setText(projectSiteNames[pop])
                      .addTo(map);
                  }
                }
              });
              divListItem.addEventListener('mouseleave', function() {
                // popup2.remove();
                $('.projectPopups').remove();
                // item.style.opacity = 1;
                divListItem.style.backgroundColor = hexToRGBaListHover("#dddddd", 0);;
              });
              var divItemDetailsON = 0;
              divListItem.addEventListener('click', function() {
                if (divItemDetailsON == 0) {
                  divItemDetailsON = 1;
                  var divItemDetails = document.createElement('div');
                  divItemDetails.className = "divItemDetailsContainer";
                  divItemDetails.style.backgroundColor = itemColor;

                  var divImgItemDetails = document.createElement('div');
                  divImgItemDetails.className = "divImgDetailsContainer";
                  var divOverviewItemDetails = document.createElement('div');
                  divOverviewItemDetails.className = "divNameDetailsContainer";
                  var divFocusItemDetails = document.createElement('div');
                  divFocusItemDetails.className = "divTextDetailsContainer";
                  var divCoIItemDetails = document.createElement('div');
                  divCoIItemDetails.className = "divCoIDetailsContainer";
                  var divProjectItemDetails = document.createElement('div');
                  divProjectItemDetails.className = "divProjectDetailsContainer";
                  var divLinkItemDetails = document.createElement('div');
                  divLinkItemDetails.className = "divLinkDetailsContainer";

                  var imgItemDetails = document.createElement('img');
                  imgItemDetails.src = getListingImage(prop.ProjectName);
                  imgItemDetails.className = "divImgDetails";

                  var overviewItemDetails = document.createElement('p');
                  overviewItemDetails.innerHTML = "<b>Overview:</b><br><br>" + prop.Overview;

                  var focusItemDetails = document.createElement('div');
                  focusItemDetails.className = "divFocusDetails";
                  focusItemDetails.innerHTML = "<b>Principal Investigator</b>: <br><br>" + prop.PI + "<br><br>";

                  var coIItemDetails = document.createElement('div');
                  coIItemDetails.className = "divcoIDetails";
                  var coIString = prop.CoI.split(";");
                  var coIList = document.createElement("ul");
                  if (coIString.length > 1) {
                    for (var c = 0; c < coIString.length; c++) {
                      var anchor = document.createElement("p");
                      anchor.innerHTML = coIString[c];
                      var elem = document.createElement("li");
                      elem.appendChild(anchor);
                      coIList.appendChild(elem);
                    }
                    coIItemDetails.innerHTML = "<b>Co-Investigator(s)</b>";
                    coIItemDetails.appendChild(coIList);
                  }

                  var projectItemDetails = document.createElement('div');
                  projectItemDetails.className = "divProjectDetails";
                  var projectString = prop.Site.split(";");
                  var projectList = document.createElement("ul");
                  if (projectString.length > 0) {
                    for (var p = 0; p < projectString.length; p++) {
                      var anchor = document.createElement("p");
                      anchor.innerHTML = projectString[p];
                      var elem = document.createElement("li");
                      elem.appendChild(anchor);
                      projectList.appendChild(elem);
                    }
                    projectItemDetails.innerHTML = "<b>Site(s)</b>";
                    projectItemDetails.appendChild(projectList);
                  }

                  var LinkItemDetails = document.createElement('a');
                  LinkItemDetails.target = '_blank';
                  LinkItemDetails.href = prop.URL;
                  LinkItemDetails.textContent = "\tMore Info";

                  divImgItemDetails.appendChild(imgItemDetails);
                  divOverviewItemDetails.appendChild(overviewItemDetails);
                  divFocusItemDetails.appendChild(focusItemDetails);
                  divCoIItemDetails.appendChild(coIItemDetails);
                  divProjectItemDetails.appendChild(projectItemDetails);
                  divLinkItemDetails.appendChild(LinkItemDetails);

                  divItemDetails.appendChild(divImgItemDetails);
                  divItemDetails.appendChild(divOverviewItemDetails);
                  divItemDetails.appendChild(divFocusItemDetails);
                  divItemDetails.appendChild(divCoIItemDetails);
                  divItemDetails.appendChild(divProjectItemDetails);
                  divItemDetails.appendChild(divLinkItemDetails);

                  item.appendChild(divItemDetails);
                  // divListItem.removeChild(spanListItem);
                }
                else if (divItemDetailsON == 1) {
                  divItemDetailsON = 0;
                  // divListItem.appendChild(spanListItem);
                  item.removeChild(item.lastChild);
                  // divItemDetails.innerHTML = '';
                }
              });

              // divListItem.appendChild(spanListItem);
              divListItem.appendChild(item);
              listingEl.appendChild(divListItem);
            });

            //add a dummy div at the last of the listing div
            var divListItem = document.createElement('div');
            divListItem.className = "divListContainer";
            divListItem.style.borderBottom = "none";
            var divDummy = document.createElement('div');
            divDummy.className = "dummyDiv";
            divListItem.appendChild(divDummy);
            listingEl.appendChild(divListItem);
          }

          document.getElementById("listViewButton").style.display = "block";
          document.getElementById("thumbnailViewButton").style.display = "block";
          document.getElementById("observatoryViewButton").style.display = "block";
          document.getElementById("projectViewButton").style.display = "block";

          // Show the filter input
          filterEl.parentNode.style.display = 'block';
        } else if (features.length === 0 && filterEl.value !== '') {
          empty.textContent = 'No results found';
          listingEl.appendChild(empty);
        } else {
          empty.textContent = 'Drag the map to populate results';
          listingEl.appendChild(empty);

          // Hide the filter input
          filterEl.parentNode.style.display = 'none';

          // remove features filter
          map.setFilter('Project', ['has', 'ProjectName']);
        }
      }
    }

    function displayFilteredList() {
      if(observatoryView == 1){
        var features = map.queryRenderedFeatures({
          layers: ['Observatory']
        });
        var siteNames = [];
        var featuresSorted = [];
        if (features) {
          // console.log('features before sorting: ', features);
          for (var i = 0; i < features.length; i++) {
            siteNames[i] = features[i].properties.Site;
          }
          sortWithIndeces(siteNames);
          // console.log('Site indices sorted: ', siteNames.sortIndices);
          for (var f = 0; f < features.length; f++) {
            featuresSorted[f] = features[siteNames.sortIndices[f]];
          }
          renderListings(featuresSorted);
          // Clear the input container
          filterEl.value = '';
          // Store the current features in `observatoryList` variable to
          // later use for filtering on `keyup`.
          observatoryList = features;
        }
      }
      else if (projectView == 1){
        var features = map.queryRenderedFeatures({
          layers: ['Project']
        });
        console.log(features);
        features = features.filter(function(obj, index, self) { return index === self.findIndex(function(t) { return t['id'] === obj['id'] }); });
        console.log('after filtering duplicates:', features);
        var projectNames = [];
        var featuresSorted = [];
        if (features) {
          // console.log('features before sorting: ', features);
          for (var i = 0; i < features.length; i++) {
            projectNames[i] = features[i].properties.ProjectName;
          }
          // console.log(projectNames);
          sortWithIndeces(projectNames);
          // console.log('Site indices sorted: ', siteNames.sortIndices);
          for (var f = 0; f < features.length; f++) {
            featuresSorted[f] = features[projectNames.sortIndices[f]];
          }
          renderListings(featuresSorted);
          // Clear the input container
          filterEl.value = '';
          // Store the current features in `observatoryList` variable to
          // later use for filtering on `keyup`.
          projectList = features;
        }
      }
    }

    // to be used with the featurestate-wise site's circle coloring
    // function changeObservatoryCircleColor() {
    //   var features = map.queryRenderedFeatures({
    //     layers: ['Observatory']
    //   });
    //   // console.log(features);
    //
    //   if (features) {
    //     // console.log('features before sorting: ', features);
    //     for (var i = 0; i < features.length; i++) {
    //
    //       // set empty initially
    //       map.setFeatureState({
    //         source: 'observatorySource',
    //         id: features[i].id
    //       }, {
    //         basin: ""
    //       });
    //
    //       for (var n = 0; n < numberOfBasins; n++) {
    //         if (basinObjects[n].coordinates.length > 1) {
    //           for (var m = 0; m < basinObjects[n].coordinates.length; m++) {
    //             if (inside([features[i].properties.X, features[i].properties.Y], basinObjects[n].coordinates[m][0]) == true) {
    //               map.setFeatureState({
    //                 source: 'observatorySource',
    //                 id: features[i].id
    //               }, {
    //                 basin: basinObjects[n].name
    //               });
    //               // console.log('updated feature: ', features[i]);
    //             }
    //           }
    //         } else {
    //           for (var m = 0; m < basinObjects[n].coordinates.length; m++) {
    //             if (inside([features[i].properties.X, features[i].properties.Y], basinObjects[n].coordinates[m]) == true) {
    //               map.setFeatureState({
    //                 source: 'observatorySource',
    //                 id: features[i].id
    //               }, {
    //                 basin: basinObjects[n].name
    //               });
    //             }
    //           }
    //         }
    //       }
    //     }
    //   }
    // }

    function normalize(string) {
      return string.trim().toLowerCase();
    }

    // function getUniqueFeatures(array, comparatorProperty) {
    //     var existingFeatureKeys = {};
    //     // Because features come from tiled vector data, feature geometries may be split
    //     // or duplicated across tile boundaries and, as a result, features may appear
    //     // multiple times in query results.
    //     var uniqueFeatures = array.filter(function (el) {
    //         if (existingFeatureKeys[el.properties[comparatorProperty]]) {
    //             return false;
    //         } else {
    //             existingFeatureKeys[el.properties[comparatorProperty]] = true;
    //             return true;
    //         }
    //     });
    //
    //     return uniqueFeatures;
    // }

    map.on('style.load', function() {

      // document.getElementById("navbarContainer").style.display = "block";
      //Canadian waterbasins
      map.addSource('basinSouce', {
        type: 'geojson',
        data: 'https://giws-comm.github.io/map/GWFbasins_v3.json',
        buffer: 5,
      });
      map.addLayer({
        'id': 'Basins',
        'type': 'fill',
        'source': 'basinSouce',
        'layout': {
          'visibility': 'visible'
        },
        'paint': {
          'fill-color': ['match',
            ['get', 'NAMRB_EN'],
            'Yukon',
            colorPalette[0],
            'Mackenzie',
            colorPalette[1],
            'Churchill',
            colorPalette[2],
            'Fraser',
            colorPalette[3],
            'Columbia',
            colorPalette[4],
            'Nelson',
            colorPalette[5],
            'St. Lawrence',
            colorPalette[6],
            'Saint John',
            colorPalette[7],
            //other
            '#A93226',
          ],
          'fill-opacity': 0.4,
          'fill-outline-color': 'black',
        }
      });

      map.addSource('projectSource', {
        type: 'geojson',
        // Point to GeoJSON data.
        data: 'GWFprojects.json',
      });
      map.addLayer({
        'id': 'Project',
        'source': 'projectSource',
        'type': 'circle',
        // 'generateId': 'true',
        layout: {
          'visibility': 'visible'
        },
        paint: {
          'circle-color': 'black',
          'circle-radius': 0.5,
          'circle-stroke-width': 0,
          // 'circle-stroke-color': 'black',
        }
      });
      // map.addLayer({
      //   "id": "numberofprojects",
      //   "type": "symbol",
      //   "source": "projectSource",
      //   "layout": {
      //     "text-field": "{NumberofSites}",
      //     "text-font": [
      //       "DIN Offc Pro Medium",
      //       "Arial Unicode MS Bold"
      //     ],
      //     "text-size": 20
      //   }
      // });

      map.addSource('observatorySource', {
        type: 'geojson',
        // Point to GeoJSON data.
        data: '2020-Jan6-GWFobservatoriesGeo_withID3.json',
        // data: 'demo.json'
        // cluster: true,
        // clusterMaxZoom: 14, // Max zoom to cluster points on
        // clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
      });
      map.addLayer({
        'id': 'Observatory',
        'source': 'observatorySource',
        'type': 'circle',
        // 'generateId': 'true',
        layout: {
          'visibility': 'visible'
        },
        paint: {
          'circle-color': [
            'match',
            ['get', 'BasinLocation'],
            'Yukon',
            colorPalette[0],
            'Mackenzie',
            colorPalette[1],
            'Churchill',
            colorPalette[2],
            'Fraser',
            colorPalette[3],
            'Columbia',
            colorPalette[4],
            'Nelson',
            colorPalette[5],
            'St. Lawrence',
            colorPalette[6],
            'Saint John',
            colorPalette[7],
            //other
            '#ccc'
          ],
          // 'circle-radius': 4,
          'circle-radius': {
            "stops": [
              [3, 4],
              // zoom is 5 -> circle radius will be 1px
              [5, 6],
              // zoom is 10 -> circle radius will be 2px
              [7, 8],
              [9, 10],
              [11, 12]
            ]
          },
          'circle-stroke-width': 2,
          'circle-stroke-color': 'black',
        }
      });
      //add layer and change circle color based on the site's basin origin on the runtime using featurestate
      // map.addLayer({
      //   'id': 'Observatory',
      //   'source': 'observatorySource',
      //   'type': 'circle',
      //   // 'generateId': 'true',
      //   layout: {
      //     'visibility': 'visible'
      //   },
      //   paint: {
      //     'circle-color':
      //     [
      //       'case',
      //               ['==', ['feature-state', 'basin'], "Yukon"], colorPalette[0],
      //               ['==', ['feature-state', 'basin'], "Mackenzie"], colorPalette[1],
      //               ['==', ['feature-state', 'basin'], "Churchill"], colorPalette[2],
      //               ['==', ['feature-state', 'basin'], "Fraser"], colorPalette[3],
      //               ['==', ['feature-state', 'basin'], "Columbia"], colorPalette[4],
      //               ['==', ['feature-state', 'basin'], "Nelson"], colorPalette[5],
      //               ['==', ['feature-state', 'basin'], "St. Lawrence"], colorPalette[6],
      //               ['==', ['feature-state', 'basin'], "Saint John"], colorPalette[7],
      //               '#ccc'
      //     ]
      //     ,
      //     // 'circle-radius': 4,
      //     'circle-radius':
      //       {"stops": [
      //         [3, 4],
      //         // zoom is 5 -> circle radius will be 1px
      //         [5, 6],
      //         // zoom is 10 -> circle radius will be 2px
      //         [7, 8],
      //         [9, 10],
      //         [11, 12]
      //     ]}
      //     ,
      //     'circle-stroke-width': 2,
      //     'circle-stroke-color': 'black',
      //     'circle-pitch-scale': 'viewport',
      //   }
      // });

      // warning: this fires many times per second!
      map.on('render', afterChangeComplete);

      function afterChangeComplete() {
        if (!map.loaded()) {
          return
        } // still not loaded; bail out.

        // now that the map is loaded, it's safe to query the features:
        document.getElementById("sidebar").style.display = "block";
        // changeObservatoryCircleColor();
        displayFilteredList();

        map.off('render', afterChangeComplete); // remove this handler now that we're done.
      }

      map.on('moveend', function() {
        displayFilteredList();
      });

      map.on('mousemove', 'Observatory', function(e) {
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';

        // Populate the popup and set its coordinates based on the feature.
        var feature = e.features[0];
        popup
          .setLngLat(feature.geometry.coordinates)
          .setText(feature.properties.Site)
          .addTo(map);
      });

      map.on('mouseleave', 'Observatory', function() {
        map.getCanvas().style.cursor = '';
        popup.remove();
      });

      filterEl.addEventListener('keyup', function(e) {
        if(observatoryView == 1){
          var value = normalize(e.target.value);

          // Filter visible features that don't match the input value.
          var filtered = observatoryList.filter(function(feature) {
            var name = normalize(feature.properties.Site);
            return name.indexOf(value) > -1;
          });

          // Populate the sidebar with filtered results
          renderListings(filtered);

          // Set the filter to populate features into the layer.
          if (filtered.length) {
            map.setFilter('Observatory', [
              'match',
              ['get', 'Site'],
              filtered.map(function(feature) {
                return feature.properties.Site;
              }),
              true,
              false
            ]);
          }
        }
        else if(projectView == 1){
          var value = normalize(e.target.value);

          // Filter visible features that don't match the input value.
          var filtered = projectList.filter(function(feature) {
            var name = normalize(feature.properties.ProjectName);
            return name.indexOf(value) > -1;
          });

          // Populate the sidebar with filtered results
          renderListings(filtered);

          // Set the filter to populate features into the layer.
          if (filtered.length) {
            map.setFilter('Project', [
              'match',
              ['get', 'ProjectName'],
              filtered.map(function(feature) {
                return feature.properties.ProjectName;
              }),
              true,
              false
            ]);
          }
        }

      });

      document.getElementById("menuLayerToggle").innerHTML = "";

      // enumerate ids of the layers
      var toggleableLayerIds = ['Basins', 'Observatory'];

      // set up the corresponding toggle button for each layer
      for (var i = 0; i < toggleableLayerIds.length; i++) {
        var id = toggleableLayerIds[i];

        var link = document.createElement('a');
        link.href = '#';
        link.className = 'active';
        link.textContent = id;

        link.onclick = function(e) {
          var clickedLayer = this.textContent;
          e.preventDefault();
          e.stopPropagation();

          var visibility = map.getLayoutProperty(clickedLayer, 'visibility');

          // toggle layer visibility by changing the layout object's visibility property
          if (visibility == 'visible') {
            map.setLayoutProperty(clickedLayer, 'visibility', 'none');
            if (clickedLayer == "Basins") {
              document.getElementById("colorPicker").style.display = "none";
              document.getElementById("basin-legend").style.display = "none";
              displayFilteredList();
            } else {
              document.getElementById("sidebar").style.display = "none";
              document.getElementById("closebtnContainer").style.display = "none";
              document.getElementById("listViewButton").style.display = "none";
              document.getElementById("thumbnailViewButton").style.display = "none";
              document.getElementById("observatoryViewButton").style.display = "none";
              document.getElementById("projectViewButton").style.display = "none";
            }
            this.className = '';
          } else {
            this.className = 'active';
            map.setLayoutProperty(clickedLayer, 'visibility', 'visible');
            if (clickedLayer == "Basins") {
              document.getElementById("colorPicker").style.display = "block";
              document.getElementById("basin-legend").style.display = "block";
              displayFilteredList();
            } else {
              document.getElementById("sidebar").style.display = "block";
              document.getElementById("closebtnContainer").style.display = "none";
              document.getElementById("listViewButton").style.display = "block";
              document.getElementById("thumbnailViewButton").style.display = "block";
              document.getElementById("observatoryViewButton").style.display = "block";
              document.getElementById("projectViewButton").style.display = "block";
              map.on('render', afterChangeComplete);
            }
          }
        };

        var layers = document.getElementById('menuLayerToggle');
        layers.appendChild(link);
      }
    });
  </script>

</body>

</html>
